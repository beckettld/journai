import"../chunks/CWj6FrbW.js";import{i as Z}from"../chunks/J7WZqsoh.js";import{aT as re,aU as de,aV as ce,A as ee,C as ne,a as s,I as N,aW as ve,E as oe,F as b,J as g,a1 as P,u as D,M as I,K as h,G as _,H as te,O as C,Q as U,s as x,W as me,aX as ue,R as G,B as pe,V as ge,U as he,d as fe}from"../chunks/DVoE9nWq.js";import{i as F,s as Se,a as J}from"../chunks/CvlPnrEX.js";import{g as K}from"../chunks/CwUqDDKe.js";import{e as we,g as _e,f as ae,h as be,a as ye,i as ke}from"../chunks/CzBqQjMQ.js";import{g as Q,a as X}from"../chunks/_4MF4a4D.js";import{e as Te,i as Ie,T as De}from"../chunks/Dgi6Ja9f.js";import{s as se}from"../chunks/BRKRlfvo.js";import{b as Me}from"../chunks/CPcXIgLt.js";import{p as z}from"../chunks/BYblgS4R.js";import{s as xe}from"../chunks/h_eNNvhY.js";import{b as $e}from"../chunks/C1UErj5t.js";const Ae=()=>{const m={mode:"vent",messages:[],startTime:0,durationMinutes:30,isActive:!1,currentDate:new Date().toISOString().split("T")[0],weekId:""},{subscribe:u,set:t,update:e}=de(m);return{subscribe:u,startSession:(n,p=n==="vent"?30:60)=>{const d=new Date,k=d.toISOString().split("T")[0],o=Q(d),r=`${X(d)}-W${String(o).padStart(2,"0")}`;t({mode:n,messages:[],startTime:Date.now(),durationMinutes:p,isActive:!0,currentDate:k,weekId:r})},addMessage:n=>{e(p=>({...p,messages:[...p.messages,{...n,timestamp:Date.now()}]}))},endSession:()=>{e(n=>({...n,isActive:!1}))},reset:()=>{t(m)},setMessages:n=>{e(p=>({...p,messages:n}))},restoreSession:(n,p,d,k)=>{const o=new Date,a=o.toISOString().split("T")[0],r=Q(o),f=`${X(o)}-W${String(r).padStart(2,"0")}`;t({mode:n,messages:d,startTime:k,durationMinutes:p,isActive:!0,currentDate:a,weekId:f})}}},q=Ae(),je=ce(0,m=>{const u=setInterval(()=>{m(Date.now())},1e3);return()=>clearInterval(u)}),ie=re([q,je],([m,u])=>{if(!m.isActive)return 0;const t=(Date.now()-m.startTime)/1e3/60;return Math.max(0,m.durationMinutes-t)}),Ee=re(ie,m=>m<=0);var Oe=b(`<div class="empty-state svelte-qha2j"><p class="empty-message svelte-qha2j">Start sharing whenever you're ready.</p> <p class="empty-hint svelte-qha2j">Your thoughts are welcome here.</p></div>`),Re=b('<span class="message-time svelte-qha2j"> </span>'),qe=b('<div><div class="message-bubble svelte-qha2j"><p class="message-content svelte-qha2j"> </p> <!></div></div>'),Fe=b('<div class="message-list svelte-qha2j"><!> <!></div>');function We(m,u){ee(u,!1);let t=z(u,"messages",24,()=>[]),e=N();ne(()=>s(e),()=>{s(e)&&setTimeout(()=>{ve(e,s(e).scrollTop=s(e).scrollHeight)},0)}),oe(),Z();var n=Fe(),p=g(n);{var d=o=>{var a=Oe();_(o,a)};F(p,o=>{P(t()),D(()=>t().length===0)&&o(d)})}var k=I(p,2);Te(k,1,t,Ie,(o,a)=>{var r=qe(),A=g(r),f=g(A),j=g(f,!0);h(f);var Y=I(f,2);{var L=E=>{var O=Re(),H=g(O,!0);h(O),C(i=>U(H,i),[()=>(s(a),D(()=>new Date(s(a).timestamp).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})))]),_(E,O)};F(Y,E=>{s(a),D(()=>s(a).timestamp)&&E(L)})}h(A),h(r),C(()=>{se(r,1,`message-group message-${s(a),D(()=>s(a).role)??""}`,"svelte-qha2j"),U(j,(s(a),D(()=>s(a).content)))}),_(o,r)}),h(n),Me(n,o=>x(e,o),()=>s(e)),_(m,n),te()}var ze=b('<span class="spinner svelte-7btu3z"></span>'),Ce=b("<span>Send</span>"),Ue=b('<p class="disabled-message svelte-7btu3z">âœ“ Session has ended. Thank you for sharing.</p>'),Le=b('<div><div class="input-wrapper svelte-7btu3z"><textarea class="input-field svelte-7btu3z" rows="3"></textarea> <button class="submit-button svelte-7btu3z"><!></button></div> <!> <p class="hint-text svelte-7btu3z">Press Ctrl+Enter to send</p></div>');function Ne(m,u){ee(u,!1);let t=z(u,"disabled",8,!1),e=z(u,"loading",8,!1),n=z(u,"placeholder",8,"Share your thoughts..."),p=z(u,"onSubmit",8,()=>{}),d=N("");function k(i){i.key==="Enter"&&i.ctrlKey&&o()}function o(){const i=s(d).trim();i&&!t()&&!e()&&(p()(i),x(d,""))}Z();var a=Le();let r;var A=g(a),f=g(A);me(f);var j=I(f,2),Y=g(j);{var L=i=>{var W=ze();_(i,W)},E=i=>{var W=Ce();_(i,W)};F(Y,i=>{e()?i(L):i(E,!1)})}h(j),h(A);var O=I(A,2);{var H=i=>{var W=Ue();_(i,W)};F(O,i=>{t()&&i(H)})}ue(2),h(a),C(i=>{r=se(a,1,"message-input-container svelte-7btu3z",null,r,{disabled:t()}),xe(f,"placeholder",n()),f.disabled=t()||e(),j.disabled=i},[()=>(P(t()),P(e()),s(d),D(()=>t()||e()||!s(d).trim()))]),$e(f,()=>s(d),i=>x(d,i)),G("keydown",f,k),G("click",j,o),_(m,a),te()}var Ye=b('<div><div class="banner-content svelte-1fh8mln"><h2 class="banner-title svelte-1fh8mln"> </h2> <p class="banner-subtitle svelte-1fh8mln"> </p></div></div>');function He(m,u){let t=z(u,"mode",8,"vent"),e=z(u,"subtext",8,"");var n=Ye();let p;var d=g(n),k=g(d),o=g(k,!0);h(k);var a=I(k,2),r=g(a,!0);h(a),h(d),h(n),C(()=>{p=se(n,1,"mode-banner svelte-1fh8mln",null,p,{mentor:t()==="mentor"}),U(o,t()==="vent"?"ğŸ“ Daily Vent Session":"ğŸ¯ Weekly Mentor Session"),U(r,e())}),_(m,n)}var Ve=b('<p class="cooldown-time svelte-hmmdep"> </p>'),Be=b('<div class="cooldown-banner svelte-hmmdep"><h3 class="svelte-hmmdep">â° Session Cooldown Active</h3> <p class="svelte-hmmdep"> </p> <!> <button class="home-button svelte-hmmdep">Return Home</button></div>'),Je=b('<div class="restored-banner svelte-hmmdep">âœ“ Your previous session has been restored</div>'),Ke=b('<div class="error-banner svelte-hmmdep"> </div>'),Pe=b('<!> <!> <div class="messages-wrapper svelte-hmmdep"><!></div> <!> <!>',1),Ge=b('<div class="session-container svelte-hmmdep"><!> <!></div>');function ct(m,u){ee(u,!1);const t=()=>J(ye,"$authUser",d),e=()=>J(q,"$sessionStore",d),n=()=>J(Ee,"$sessionExpired",d),p=()=>J(ie,"$timeRemaining",d),[d,k]=Se();let o=N(!1),a=N(null),r=N(null),A=N(!1),f=null;pe(async()=>{if(!t()){K("/");return}const c=new Date,l=Q(c),y=`${X(c)}-W${String(l).padStart(2,"0")}`,$=c.toISOString().split("T")[0];try{await we(t().uid,y)}catch(S){console.error("Failed to create week document:",S)}const v=await _e(t().uid,y,$);if(v&&v.mode==="vent"){const S=(Date.now()-v.startTime)/1e3/60;Math.max(0,v.durationMinutes-S)>0?(q.restoreSession("vent",v.durationMinutes,v.messages,v.startTime),x(A,!0)):await j(y)}else await j(y);e().isActive&&(f=setInterval(async()=>{var S;if((S=t())!=null&&S.uid&&e().isActive&&e().messages.length>0)try{await ae(t().uid,e().weekId,e().currentDate,{mode:e().mode,messages:e().messages,startTime:e().startTime,durationMinutes:e().durationMinutes})}catch(T){console.error("Failed to save draft:",T)}},5e3))}),ge(()=>{f&&clearInterval(f)});async function j(c){if(t())try{x(r,await be(t().uid,c)),s(r).canStart&&q.startSession("vent",30)}catch(l){console.error("Failed to check cooldown:",l),q.startSession("vent",30)}}async function Y(c){var M,y;const l=c;if(l){x(o,!0),x(a,null);try{q.addMessage({role:"user",content:l});const v=await(await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:l,mode:"vent",history:e().messages.filter(S=>S.role==="user"),uid:(M=t())==null?void 0:M.uid,weekId:e().weekId})})).json();if(!v.success)throw new Error(v.error||"Failed to get response");if(q.addMessage({role:"assistant",content:v.reply}),(y=t())!=null&&y.uid)try{await ae(t().uid,e().weekId,e().currentDate,{mode:e().mode,messages:e().messages,startTime:e().startTime,durationMinutes:e().durationMinutes})}catch(S){console.error("Failed to save draft:",S)}}catch($){x(a,$.message||"Something went wrong")}finally{x(o,!1)}}}async function L(){var c;x(o,!0);try{if((c=t())!=null&&c.uid){const l=new Date(e().startTime),M=l.getFullYear(),y=String(l.getMonth()+1).padStart(2,"0"),$=String(l.getDate()).padStart(2,"0"),v=String(l.getHours()).padStart(2,"0"),S=String(l.getMinutes()).padStart(2,"0"),T=String(l.getSeconds()).padStart(2,"0"),R=`${M}-${y}-${$}_${v}-${S}-${T}`;console.log("Saving vent session:",{uid:t().uid,weekId:e().weekId,sessionId:R,startTime:e().startTime,messageCount:e().messages.length});const w=await(await fetch("/api/logs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uid:t().uid,weekId:e().weekId,entryId:R,mode:"vent",messages:e().messages,startTime:e().startTime,durationMinutes:e().durationMinutes})})).json();if(console.log("Save response:",w),!w.success)throw new Error(w.error||"Failed to save session");await ke(t().uid,e().weekId,e().currentDate)}q.endSession(),setTimeout(()=>K("/"),2e3)}catch(l){console.error("Error in handleSessionEnd:",l),x(a,l.message||"Failed to save session")}finally{x(o,!1)}}ne(()=>(n(),e()),()=>{n()&&e().isActive&&L()}),oe(),Z();var E=Ge(),O=g(E);He(O,{mode:"vent",subtext:"30 minutes to vent â€” I'll just listen."});var H=I(O,2);{var i=c=>{var l=Be(),M=I(g(l),2),y=g(M);h(M);var $=I(M,2);{var v=T=>{var R=Ve(),B=g(R);h(R),C(w=>U(B,`Last session: ${w??""}`),[()=>(s(r),D(()=>s(r).lastSessionAt.toLocaleString()))]),_(T,R)};F($,T=>{s(r),D(()=>s(r).lastSessionAt)&&T(v)})}var S=I($,2);h(l),C(T=>U(y,`You can start a new vent session in 
        ${T??""}
        .`),[()=>(s(r),D(()=>s(r).hoursRemaining?`${Math.ceil(s(r).hoursRemaining)} hour${Math.ceil(s(r).hoursRemaining)>1?"s":""}`:"a few minutes"))]),G("click",S,()=>K("/")),_(c,l)},W=c=>{var l=Pe(),M=he(l);De(M,{get timeRemaining(){return p()},totalDuration:30,get isActive(){return e(),D(()=>e().isActive)},onExpired:L});var y=I(M,2);{var $=w=>{var V=Je();_(w,V)};F(y,w=>{s(A)&&w($)})}var v=I(y,2),S=g(v);We(S,{get messages(){return e(),D(()=>e().messages)}}),h(v);var T=I(v,2);{var R=w=>{var V=Ke(),le=g(V,!0);h(V),C(()=>U(le,s(a))),_(w,V)};F(T,w=>{s(a)&&w(R)})}var B=I(T,2);{let w=fe(()=>(e(),D(()=>!e().isActive)));Ne(B,{get disabled(){return s(w)},get loading(){return s(o)},placeholder:"Share what's on your mind...",onSubmit:Y})}_(c,l)};F(H,c=>{s(r),D(()=>s(r)&&!s(r).canStart)?c(i):c(W,!1)})}h(E),_(m,E),te(),k()}export{ct as component};

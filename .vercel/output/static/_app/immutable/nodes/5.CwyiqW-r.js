import"../chunks/CWj6FrbW.js";import{i as Ye}from"../chunks/J7WZqsoh.js";import{A as Be,B as Ge,V as qe,C as pe,E as He,F as u,O as E,a as s,R as fe,G as i,H as Qe,I as p,M as f,u as h,Q as M,J as n,s as t,K as r,W as Ve,U as Y,T as ae,X as ge}from"../chunks/DVoE9nWq.js";import{i as x,s as Xe,a as ze}from"../chunks/CvlPnrEX.js";import{T as Ze,s as $e,e as te,i as ye}from"../chunks/Dgi6Ja9f.js";import{s as es}from"../chunks/h_eNNvhY.js";import{b as ss}from"../chunks/C1UErj5t.js";import{g as _e}from"../chunks/CwUqDDKe.js";import{a as as}from"../chunks/CzBqQjMQ.js";import{i as ts,c as rs}from"../chunks/DdzNvqjO.js";import{g as ns,a as os}from"../chunks/_4MF4a4D.js";var is=u('<li class="svelte-m1nv4n"> </li>'),ls=u('<ul class="summary-list svelte-m1nv4n"></ul>'),vs=u('<p class="summary-placeholder svelte-m1nv4n"> </p>'),ms=u('<p class="summary-placeholder svelte-m1nv4n">No observations available yet.</p>'),us=u('<li class="svelte-m1nv4n"> </li>'),cs=u('<ul class="summary-list svelte-m1nv4n"></ul>'),ds=u('<p class="summary-placeholder svelte-m1nv4n"> </p>'),ps=u('<p class="summary-placeholder svelte-m1nv4n">No suggestions available yet.</p>'),fs=u('<div class="summary-group svelte-m1nv4n"><p class="summary-subheader svelte-m1nv4n">What I Noticed</p> <!></div> <div class="summary-group svelte-m1nv4n"><p class="summary-subheader svelte-m1nv4n">Focus For Next Week</p> <!></div>',1),gs=u('<span class="summary-placeholder svelte-m1nv4n"> </span>'),ys=u('<div class="user-message-row svelte-m1nv4n"><div class="user-message-bubble svelte-m1nv4n"> </div></div>'),_s=u('<p class="user-placeholder svelte-m1nv4n">Your reflections will appear here after you send them.</p>'),hs=u('<div class="error-banner svelte-m1nv4n"> </div>'),ws=u('<div class="session-complete-banner svelte-m1nv4n"><h3 class="svelte-m1nv4n">âœ“ Your weekly reflection is complete.</h3> <p class="svelte-m1nv4n">Returning to home...</p></div>'),bs=u('<div class="page-container svelte-m1nv4n"><div class="left-column svelte-m1nv4n"><section class="summary-card svelte-m1nv4n"><div class="summary-header svelte-m1nv4n"><span>Weekly Mentor Summary</span> <small class="svelte-m1nv4n">Generated from your journal entries for this week.</small></div> <div class="summary-body svelte-m1nv4n"><!></div></section> <div class="creature-container svelte-m1nv4n"><img alt="Capybara guide" class="creature svelte-m1nv4n"/> <div class="speech-bubble svelte-m1nv4n"> </div></div></div> <div class="chat-panel svelte-m1nv4n"><div class="timer-row svelte-m1nv4n"><!></div> <section class="reflection-section svelte-m1nv4n"><div class="user-message-feed svelte-m1nv4n" aria-live="polite"><!></div> <textarea class="mentor-input svelte-m1nv4n" placeholder="Capture the themes, moments, or questions that feel most important right now..."></textarea> <div class="input-actions svelte-m1nv4n"><button class="submit-button svelte-m1nv4n"><!></button></div></section> <!> <!></div></div>');function Us(he,we){Be(we,!1);const I=()=>ze(as,"$authUser",be),[be,ke]=Xe();let b=p(!1),R=p(null),W=p(""),B=p("Share what stood out this week. I am listening."),o=p(null),C=p("Loading a reflection summary from your journal entries..."),G=p(!1),q=!1,k=p("");const L=60;let H=p(L),w=p(!1),Q=!1,re=0,F=null,S=p([]),A=p([]);function Se(){const e=new Date,a=ns(e),l=os(e);t(k,`${l}-W${String(a).padStart(2,"0")}`)}function J(){F&&(clearInterval(F),F=null)}function xe(){J(),t(w,!0),Q=!1,re=Date.now(),t(H,L),F=setInterval(()=>{const e=(Date.now()-re)/1e3/60,a=Math.max(0,L-e);t(H,a),a===0&&(J(),ne())},1e3)}Ge(()=>{if(!I()){_e("/");return}Se(),xe();const e="Welcome to your weekly reflection session. I've reviewed everything you shared with me this week. Let's explore what patterns I noticed and what might be helpful for you going forward. What would you like to focus on today?";t(B,e),t(S,[{role:"assistant",content:e,timestamp:Date.now()}])}),qe(()=>{J()});async function Ie(){var e;if(!(q||!((e=I())!=null&&e.uid)||!s(k))){q=!0;try{const a=new URLSearchParams({uid:I().uid,weekId:s(k)}),m=await(await fetch(`/api/journal/summary?${a.toString()}`)).json();m.success&&m.summary?(t(o,m.summary),t(C,m.summary.message??"")):(t(o,null),t(C,m.error||"No journal entries were found for this week."))}catch(a){const l=a instanceof Error?a.message:String(a);t(o,null),t(C,l||"Unable to load your weekly summary right now."),console.error("Failed to load journal summary:",a)}finally{t(G,!0),q=!1}}}async function Te(e){var l;const a=e;if(!(!a||!s(k)||!s(w))){t(b,!0),t(R,null);try{const m=s(S).map(({role:O,content:ee})=>({role:O,content:ee})),T={role:"user",content:a,timestamp:Date.now()};t(S,[...s(S),T]);const g=await(await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:a,mode:"mentor",history:m,uid:(l=I())==null?void 0:l.uid,weekId:s(k)})})).json();if(!g.success||!g.reply)throw new Error(g.error||"Failed to get mentor response");t(B,g.reply),t(S,[...s(S),{role:"assistant",content:g.reply,timestamp:Date.now()}])}catch(m){t(R,m.message||"Something went wrong")}finally{t(b,!1)}}}async function ne(){var e;if(!(!s(w)&&Q)){t(b,!0),t(w,!1),Q=!0,J();try{(e=I())!=null&&e.uid&&s(k)&&await fetch("/api/logs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uid:I().uid,weekId:s(k),entryId:"mentor",mode:"mentor",messages:s(S)})})}catch(a){console.error("Error saving session:",a)}finally{t(b,!1),setTimeout(()=>_e("/"),3e3)}}}function Ee(e){e.key==="Enter"&&e.ctrlKey&&(e.preventDefault(),oe())}function oe(){const e=s(W).trim();!e||!s(w)||s(b)||(Te(e),t(W,""))}pe(()=>s(S),()=>{t(A,s(S).filter(e=>e.role==="user"))}),pe(()=>(s(G),s(k),I()),()=>{var e;!s(G)&&s(k)&&((e=I())!=null&&e.uid)&&Ie()}),He(),Ye();var K=bs(),V=n(K),X=n(V),ie=f(n(X),2),Me=n(ie);{var Ne=e=>{var a=fs(),l=Y(a),m=f(n(l),2);{var T=c=>{var d=ls();te(d,5,()=>(s(o),h(()=>s(o).noticed)),ye,(N,D)=>{var y=is(),v=n(y,!0);r(y),E(()=>M(v,s(D))),i(N,y)}),r(d),i(c,d)},j=c=>{var d=ae(),N=Y(d);{var D=v=>{var _=vs(),se=n(_,!0);r(_),E(()=>M(se,(s(o),h(()=>s(o).message)))),i(v,_)},y=v=>{var _=ms();i(v,_)};x(N,v=>{s(o),h(()=>s(o).message)?v(D):v(y,!1)},!0)}i(c,d)};x(m,c=>{s(o),h(()=>s(o).noticed.length)?c(T):c(j,!1)})}r(l);var g=f(l,2),O=f(n(g),2);{var ee=c=>{var d=cs();te(d,5,()=>(s(o),h(()=>s(o).focus)),ye,(N,D)=>{var y=us(),v=n(y,!0);r(y),E(()=>M(v,s(D))),i(N,y)}),r(d),i(c,d)},Pe=c=>{var d=ae(),N=Y(d);{var D=v=>{var _=ds(),se=n(_,!0);r(_),E(()=>M(se,(s(o),h(()=>s(o).message)))),i(v,_)},y=v=>{var _=ps();i(v,_)};x(N,v=>{s(o),h(()=>s(o).message)?v(D):v(y,!1)},!0)}i(c,d)};x(O,c=>{s(o),h(()=>s(o).focus.length)?c(ee):c(Pe,!1)})}r(g),i(e,a)},De=e=>{var a=gs(),l=n(a,!0);r(a),E(()=>M(l,s(C))),i(e,a)};x(Me,e=>{s(o)?e(Ne):e(De,!1)})}r(ie),r(X);var le=f(X,2),ve=n(le),me=f(ve,2),We=n(me,!0);r(me),r(le),r(V);var ue=f(V,2),z=n(ue),je=n(z);Ze(je,{get timeRemaining(){return s(H)},totalDuration:L,get isActive(){return s(w)},onExpired:ne}),r(z);var Z=f(z,2),$=n(Z),Ue=n($);{var Oe=e=>{var a=ae(),l=Y(a);te(l,3,()=>s(A),(m,T)=>m.timestamp??T,(m,T)=>{var j=ys(),g=n(j),O=n(g,!0);r(g),r(j),E(()=>M(O,(s(T),h(()=>s(T).content)))),i(m,j)}),i(e,a)},Re=e=>{var a=_s();i(e,a)};x(Ue,e=>{s(A),h(()=>s(A).length)?e(Oe):e(Re,!1)})}r($);var U=f($,2);Ve(U);var ce=f(U,2),P=n(ce),Ce=n(P);{var Le=e=>{var a=ge("Sending...");i(e,a)},Fe=e=>{var a=ge("Send");i(e,a)};x(Ce,e=>{s(b)?e(Le):e(Fe,!1)})}r(P),r(ce),r(Z);var de=f(Z,2);{var Ae=e=>{var a=hs(),l=n(a,!0);r(a),E(()=>M(l,s(R))),i(e,a)};x(de,e=>{s(R)&&e(Ae)})}var Je=f(de,2);{var Ke=e=>{var a=ws();i(e,a)};x(Je,e=>{s(w)||e(Ke)})}r(ue),r(K),E(e=>{$e(K,`background-image: url('${ts}')`),es(ve,"src",rs),M(We,s(B)),U.disabled=!s(w)||s(b),P.disabled=e},[()=>(s(w),s(b),s(W),h(()=>!s(w)||s(b)||!s(W).trim()))]),ss(U,()=>s(W),e=>t(W,e)),fe("keydown",U,Ee),fe("click",P,oe),i(he,K),Qe(),ke()}export{Us as component};
